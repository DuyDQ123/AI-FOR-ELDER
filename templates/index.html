{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Lịch uống thuốc hôm nay -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Lịch Uống Thuốc Hôm Nay</h4>
            </div>
            <div class="card-body">
                {% if schedules %}
                    <div class="list-group">
                    {% for schedule in schedules %}
                        {% for medicine in medicines %}
                            {% if medicine.id == schedule.medicine_id %}
                                <div class="list-group-item schedule-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="flex-grow-1">
                                            <h5 class="mb-1">{{ medicine.name }}</h5>
                                            <p class="mb-1"><i class="fas fa-clock text-primary"></i> Thời gian: {{ schedule.time }}</p>
                                            <p class="mb-1"><i class="fas fa-box text-info"></i> Ngăn: {{ medicine.compartment_number }}</p>
                                            <p class="mb-1"><i class="fas fa-calendar text-success"></i> Ngày:
                                                {% if schedule.days %}
                                                    {% set days_list = schedule.days if schedule.days is not string else schedule.days|from_json %}
                                                    {% set day_names = {
                                                        'monday': 'Thứ 2',
                                                        'tuesday': 'Thứ 3',
                                                        'wednesday': 'Thứ 4',
                                                        'thursday': 'Thứ 5',
                                                        'friday': 'Thứ 6',
                                                        'saturday': 'Thứ 7',
                                                        'sunday': 'Chủ nhật'
                                                    } %}
                                                    {% for day in days_list %}
                                                        {{ day_names[day] }}{% if not loop.last %}, {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            </p>
                                            {% if medicine.notes %}
                                                <small class="text-muted"><i class="fas fa-sticky-note"></i> {{ medicine.notes }}</small>
                                            {% endif %}
                                        </div>
                                        <div class="schedule-actions">
                                            <button class="btn btn-success btn-sm confirm-medicine" data-schedule-id="{{ schedule.id }}" title="Đánh dấu đã uống thuốc">
                                                <i class="fas fa-check"></i> Đã uống
                                            </button>
                                            <form method="POST" action="{{ url_for('main.delete_schedule', schedule_id=schedule.id) }}" class="d-inline">
                                                <button class="btn btn-outline-danger btn-sm" type="submit"
                                                        onclick="return confirm('Bạn có chắc muốn xóa lịch uống thuốc này không? nếu xoá đi thì lịch sử uống thuốc dựa trên nó cũng sẽ bị xoá')"
                                                        {% if not current_user.is_authenticated %}disabled{% endif %}
                                                        title="Xóa lịch uống thuốc">
                                                    <i class="fas fa-trash"></i> Xoá
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                    </div>
                {% else %}
                    <p class="text-center">Không có lịch uống thuốc nào cho hôm nay</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Danh sách thuốc -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Danh Sách Thuốc</h4>
            </div>
            <div class="card-body">
                {% if medicines %}
                    <div class="list-group">
                    {% for medicine in medicines %}
                        <div class="list-group-item">
                            <h5 class="mb-1">{{ medicine.name }}</h5>
                            <p class="mb-1">{{ medicine.description }}</p>
                            {% if medicine.image %}
                                <img src="{{ medicine.image }}" alt="{{ medicine.name }}" class="img-thumbnail mb-2" style="max-width: 100px;">
                            {% endif %}
                        </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <p class="text-center">Chưa có thuốc nào được thêm vào</p>
                {% endif %}
            </div>
        </div>

        <!-- Nút thêm nhanh -->
        <div class="d-grid gap-2">
            <a href="{{ url_for('main.add_medicine') }}" class="btn btn-primary mb-2">
                <i class="fas fa-plus"></i> Thêm Thuốc Mới
            </a>
            <a href="{{ url_for('main.add_schedule') }}" class="btn btn-success mb-2">
                <i class="fas fa-clock"></i> Thêm Lịch Uống Thuốc
            </a>
        </div>
    </div>
</div>

<!-- Thông báo -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-primary text-white">
            <strong class="me-auto">Nhắc nhở</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            Đã đến giờ uống thuốc!
        </div>
    </div>
</div>
{% endblock %}