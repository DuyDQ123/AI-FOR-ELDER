{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Quản Lý Người Dùng</h2>
                <div class="btn-group">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createUserModal">
                        <i class="fas fa-plus"></i> Tạo Tài Khoản Mới
                    </button>
                    <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#testEmailModal">
                        <i class="fas fa-envelope-open-text"></i> Test Email
                    </button>
                </div>
            </div>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Tên đăng nhập</th>
                            <th>Họ và tên</th>
                            <th>Email</th>
                            <th>Vai trò</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>
                                <strong>{{ user.username }}</strong>
                                {% if user.user_type %}
                                    <br><small class="text-muted">
                                        {% if user.user_type == 'patient' %}Bệnh nhân
                                        {% elif user.user_type == 'caregiver' %}Người chăm sóc
                                        {% else %}{{ user.user_type }}{% endif %}
                                    </small>
                                {% endif %}
                            </td>
                            <td>
                                {{ user.full_name or '-' }}
                                {% if user.age %}
                                    <br><small class="text-muted">{{ user.age }} tuổi</small>
                                {% endif %}
                            </td>
                            <td>
                                {{ user.email }}
                                {% if user.phone %}
                                    <br><small class="text-muted">{{ user.phone }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.role == 'admin' %}
                                    <span class="badge bg-danger">Admin</span>
                                {% else %}
                                    <span class="badge bg-primary">User</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.status == 'active' %}
                                    <span class="badge bg-success">Hoạt động</span>
                                {% else %}
                                    <span class="badge bg-warning">Bị khóa</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <!-- Lock/Unlock -->
                                    <form method="POST" action="{{ url_for('main.manage_user', user_id=user.id) }}" class="d-inline">
                                        {% if user.status == 'active' %}
                                            <button type="submit" name="action" value="lock" class="btn btn-warning btn-sm">
                                                Khóa
                                            </button>
                                        {% else %}
                                            <button type="submit" name="action" value="unlock" class="btn btn-success btn-sm">
                                                Mở khóa
                                            </button>
                                        {% endif %}
                                    </form>
                                    
                                    <!-- Change Role -->
                                    <form method="POST" action="{{ url_for('main.manage_user', user_id=user.id) }}" class="d-inline">
                                        <input type="hidden" name="action" value="change_role">
                                        <div class="input-group" style="width: 190px;">
                                            <select name="role" class="form-select form-select-sm">
                                                <option value="user" {% if user.role == 'user' %}selected{% endif %}>User</option>
                                                <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                                            </select>
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                Đổi
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Include form tạo user đầy đủ -->
{% include 'admin/create_user_form.html' %}

<!-- Modal Test Email Notification -->
<div class="modal fade" id="testEmailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-envelope-open-text"></i> Test Email Notification
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Test hệ thống thông báo email:</strong> Gửi email thử nghiệm để kiểm tra cấu hình.
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Email nhận thử nghiệm <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" id="testEmail" placeholder="test@gmail.com" required>
                    <small class="text-muted">Email sẽ nhận thông báo test</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Số điện thoại SMS (tùy chọn)</label>
                    <input type="tel" class="form-control" id="testPhone" placeholder="0987654321">
                    <small class="text-muted">Để test SMS backup nếu có cấu hình</small>
                </div>
                
                <div id="testResult" class="mt-3" style="display: none;"></div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Đóng
                </button>
                <button type="button" class="btn btn-info" onclick="sendTestEmail()">
                    <i class="fas fa-paper-plane"></i> Gửi Test Email
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Function để test email notification
function sendTestEmail() {
    const email = document.getElementById('testEmail').value;
    const phone = document.getElementById('testPhone').value;
    const resultDiv = document.getElementById('testResult');
    
    if (!email) {
        alert('Vui lòng nhập email để test!');
        return;
    }
    
    // Show loading
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Đang gửi email test...</div>';
    
    // Send test email
    fetch('/api/test_email_notification', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            email: email,
            phone: phone || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let resultHtml = '<div class="alert alert-success"><h6><i class="fas fa-check"></i> Kết quả test:</h6><ul class="mb-0">';
            
            // Email result
            if (data.results.email) {
                if (data.results.email.success) {
                    resultHtml += '<li><strong>✅ Email:</strong> Gửi thành công!</li>';
                } else {
                    resultHtml += '<li><strong>❌ Email:</strong> ' + data.results.email.message + '</li>';
                }
            }
            
            // SMS result
            if (data.results.sms) {
                if (data.results.sms.success) {
                    resultHtml += '<li><strong>✅ SMS:</strong> Gửi thành công!</li>';
                } else {
                    resultHtml += '<li><strong>❌ SMS:</strong> ' + data.results.sms.message + '</li>';
                }
            }
            
            resultHtml += '</ul></div>';
            resultDiv.innerHTML = resultHtml;
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> <strong>Lỗi:</strong> ' + data.error + '</div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> <strong>Lỗi kết nối:</strong> Không thể gửi test email</div>';
    });
}

// Clear test result when modal closes
document.getElementById('testEmailModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('testResult').style.display = 'none';
    document.getElementById('testEmail').value = '';
    document.getElementById('testPhone').value = '';
});
</script>
{% endblock %}